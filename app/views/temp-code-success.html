{% extends "govuk-prototype-kit/layouts/govuk-branded.html" %}

{% block pageTitle %}
  Temporary code created – GOV.UK Digital ID
{% endblock %}

{% block header %}
  {{ govukHeader({
    homepageUrl: "/",
    serviceName: "GOV.UK Digital ID",
    serviceUrl: "/digital-id-home",
    navigation: [
      {
        href: "/digital-id-home",
        text: "Home"
      },
      {
        href: "#",
        text: "Settings"
      },
      {
        href: "#",
        text: "Sign out"
      }
    ]
  }) }}
{% endblock %}

{% block content %}
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds">
      
      <div class="govuk-panel govuk-panel--confirmation">
        <h1 class="govuk-panel__title">
          Temporary code created
        </h1>
        <div class="govuk-panel__body">
          Share this code with the third party
        </div>
      </div>

      <div class="govuk-!-margin-top-6">
        <h2 class="govuk-heading-m" id="code-heading">Your temporary identity code</h2>
        
        <div class="govuk-grid-row">
          <div class="govuk-grid-column-two-thirds">
            <div style="background-color: #f3f2f1; padding: 15px; border-left: 4px solid #1d70b8;">
              <p class="govuk-body" style="font-family: monospace; font-size: 20px; word-break: break-all; margin-bottom: 0;" id="temp-code">
                <!-- Code will be generated by JavaScript -->
              </p>
            </div>
            <div>
              <button class="govuk-button govuk-button--secondary govuk-!-margin-top-3 govuk-!-margin-bottom-0" data-module="govuk-button" id="copy-button" onclick="copyToClipboard()">
                Copy code to clipboard
              </button>
              <span id="copy-success" class="govuk-body-s" style="display: none; color: #00703c; margin-left: 10px;">
                ✓ Code copied
              </span>
            </div>
            <button class="govuk-button govuk-button--secondary govuk-!-margin-top-3" data-module="govuk-button" id="apple-wallet-button">
              Add to Apple Wallet
            </button>
          </div>
          
          <div class="govuk-grid-column-one-third">
            <div class="qr-code-container" style="text-align: center;">
              <div id="qrcode" style="display: inline-block;"></div>
            </div>
          </div>
        </div>

        <div class="govuk-warning-text">
          <span class="govuk-warning-text__icon" aria-hidden="true">!</span>
          <strong class="govuk-warning-text__text">
            <span class="govuk-visually-hidden">Warning</span>
            <span id="expiry-warning">This code will expire after one use</span>
          </strong>
        </div>
      </div>

      <h2 class="govuk-heading-m">Information security and privacy</h2>
      
      <ul class="govuk-list" id="privacy-list">
        <!-- Will be populated by JavaScript -->
      </ul>

      <h2 class="govuk-heading-m">What happens next</h2>
      
      <p class="govuk-body">
        You can share this code with a website or organisation that needs to verify your identity. You can also present this QR code (from this screen or your Apple Wallet) to someone who needs to confirm your identity.
      </p>

      <div class="govuk-button-group govuk-!-margin-top-6">
        <a href="/create-temp-code" class="govuk-button govuk-button--secondary" data-module="govuk-button">
          Create another code
        </a>
        <a href="/digital-id-home" class="govuk-link">
          Return to home
        </a>
      </div>
    </div>
  </div>

  <!-- QR Code Library -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

  <script>
    // Generate a 32-character random code
    function generateTempCode() {
      var chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // Removed confusing characters
      var code = '';
      for (var i = 0; i < 32; i++) {
        code += chars.charAt(Math.floor(Math.random() * chars.length));
        // Add hyphens every 8 characters for readability
        if ((i + 1) % 8 === 0 && i < 31) {
          code += '-';
        }
      }
      return code;
    }

    // Copy code to clipboard
    function copyToClipboard() {
      var codeText = document.getElementById('temp-code').textContent.trim();
      
      navigator.clipboard.writeText(codeText).then(function() {
        // Show success message
        var successMsg = document.getElementById('copy-success');
        successMsg.style.display = 'inline';
        
        // Hide after 3 seconds
        setTimeout(function() {
          successMsg.style.display = 'none';
        }, 3000);
      }, function() {
        // Fallback for older browsers
        var textArea = document.createElement('textarea');
        textArea.value = codeText;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        
        var successMsg = document.getElementById('copy-success');
        successMsg.style.display = 'inline';
        setTimeout(function() {
          successMsg.style.display = 'none';
        }, 3000);
      });
    }

    // Populate page with data
    (function() {
      // Generate and display the code
      var code = generateTempCode();
      document.getElementById('temp-code').textContent = code;

      var qrcodeContainer = document.getElementById('qrcode');
      var qrcodeInstance = null;

      // Function to generate QR code with responsive sizing
      function generateQRCode() {
        if (!qrcodeContainer || typeof QRCode === 'undefined') return;
        
        // Clear existing QR code
        qrcodeContainer.innerHTML = '';
        
        // Detect screen width and set QR size accordingly
        var screenWidth = window.innerWidth;
        var qrSize;
        
        if (screenWidth <= 640) {
          // Mobile: use most of screen width (accounting for padding)
          qrSize = Math.min(screenWidth - 60, 400);
        } else {
          // Desktop: fixed size
          qrSize = 150;
        }
        
        new QRCode(qrcodeContainer, {
          text: code,
          width: qrSize,
          height: qrSize,
          colorDark: '#0b0c0c',
          colorLight: '#ffffff',
          correctLevel: QRCode.CorrectLevel.H
        });
      }

      // Generate initial QR code
      generateQRCode();

      // Regenerate QR code on window resize (with debouncing)
      var resizeTimeout;
      window.addEventListener('resize', function() {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(function() {
          generateQRCode();
        }, 250);
      });

      // Get form data from URL parameters or use defaults
      var urlParams = new URLSearchParams(window.location.search);
      
      var checkType = urlParams.get('check-type') || 'Right-to-Work';
      var recordCheck = urlParams.get('record-check') || 'yes';
      var dataReturn = urlParams.get('data-return') || 'photo-name';
      var duration = urlParams.get('duration') || '1hour';

      // Update heading with check type
      document.getElementById('code-heading').textContent = 'Your temporary ' + checkType + ' code';

      // Calculate expiry time based on duration
      var durationMilliseconds = {
        '1hour': 1 * 60 * 60 * 1000,
        '1day': 24 * 60 * 60 * 1000,
        '3days': 3 * 24 * 60 * 60 * 1000,
        '7days': 7 * 24 * 60 * 60 * 1000,
        '30days': 30 * 24 * 60 * 60 * 1000
      };
      
      var durationText = {
        '1hour': '1 hour',
        '1day': '1 day',
        '3days': '3 days',
        '7days': '7 days',
        '30days': '30 days'
      };
      
      var now = new Date();
      var expiry = new Date(now.getTime() + (durationMilliseconds[duration] || durationMilliseconds['1hour']));
      var expiryString = expiry.toLocaleString('en-GB', { 
        day: 'numeric', 
        month: 'long', 
        year: 'numeric',
        hour: '2-digit', 
        minute: '2-digit'
      });

      // Update warning text with duration and expiry time
      document.getElementById('expiry-warning').textContent = 
        'This code will expire in ' + (durationText[duration] || '1 hour') + ' or after one use (' + expiryString + ')';

      // Build privacy list with ticks and crosses
      var privacyList = document.getElementById('privacy-list');
      var privacyItems = [];
      
      // Data sharing item
      if (dataReturn === 'none') {
        privacyItems.push({
          icon: '✕',
          color: '#d4351c',
          text: 'No information will be shared when this code is checked'
        });
      } else {
        var sharingText = 'Your photo will be shared when this code is checked';
        if (dataReturn === 'photo-name') {
          sharingText = 'Your photo and full name will be shared when this code is checked';
        } else if (dataReturn === 'full') {
          sharingText = 'Your photo, full name, date of birth and nationality will be shared when this code is checked';
        }
        privacyItems.push({
          icon: '✓',
          color: '#00703c',
          text: sharingText
        });
      }
      
      // Recording item
      if (recordCheck === 'yes') {
        privacyItems.push({
          icon: '✓',
          color: '#00703c',
          text: 'This check will be recorded against your Digital ID when the code is checked'
        });
      } else {
        privacyItems.push({
          icon: '✕',
          color: '#d4351c',
          text: 'This check will not be recorded against your Digital ID'
        });
      }
      
      // Populate the list
      privacyItems.forEach(function(item) {
        var li = document.createElement('li');
        li.innerHTML = '<span style="color: ' + item.color + '; font-weight: bold; margin-right: 10px;">' + 
                       item.icon + '</span>' + item.text;
        li.style.marginBottom = '10px';
        privacyList.appendChild(li);
      });
    })();
  </script>
{% endblock %}

