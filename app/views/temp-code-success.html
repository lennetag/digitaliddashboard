{% extends "govuk-prototype-kit/layouts/govuk-branded.html" %}

{% block pageTitle %}
  Temporary code created – GOV.UK One Login
{% endblock %}

{% block header %}
  {{ govukHeader({
    homepageUrl: "/",
    serviceName: "GOV.UK One Login",
    serviceUrl: "/digital-id-home",
    navigation: [
      {
        href: "/digital-id-home",
        text: "Home"
      },
      {
        href: "#",
        text: "Settings"
      },
      {
        href: "#",
        text: "Sign out"
      }
    ]
  }) }}
{% endblock %}

{% block content %}
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds">
      
      <div class="govuk-panel govuk-panel--confirmation">
        <h1 class="govuk-panel__title">
          Temporary code created
        </h1>
        <div class="govuk-panel__body">
          Share this code with the third party
        </div>
      </div>

      <div class="govuk-!-margin-top-6">
        <h2 class="govuk-heading-m">Your temporary identity code</h2>
        
        <div class="govuk-grid-row">
          <div class="govuk-grid-column-two-thirds">
            <div style="background-color: #f3f2f1; padding: 20px; margin-bottom: 20px; border-left: 4px solid #1d70b8;">
              <p class="govuk-body" style="font-family: monospace; font-size: 20px; word-break: break-all; margin-bottom: 10px;" id="temp-code">
                <!-- Code will be generated by JavaScript -->
              </p>
              <button class="govuk-button govuk-button--secondary" data-module="govuk-button" id="copy-button" onclick="copyToClipboard()">
                Copy code to clipboard
              </button>
              <span id="copy-success" class="govuk-body-s" style="display: none; color: #00703c; margin-left: 10px;">
                ✓ Code copied
              </span>
            </div>
          </div>
          
          <div class="govuk-grid-column-one-third">
            <div style="background-color: #ffffff; padding: 15px; border: 1px solid #b1b4b6; text-align: center;">
              <p class="govuk-body-s" style="margin-bottom: 10px;"><strong>Scan QR code</strong></p>
              <div id="qrcode" style="display: inline-block;"></div>
            </div>
          </div>
        </div>

        <div class="govuk-warning-text">
          <span class="govuk-warning-text__icon" aria-hidden="true">!</span>
          <strong class="govuk-warning-text__text">
            <span class="govuk-visually-hidden">Warning</span>
            This code will expire in 1 hour or after one use
          </strong>
        </div>
      </div>

      <h2 class="govuk-heading-m">Code details</h2>
      
      <dl class="govuk-summary-list">
        <div class="govuk-summary-list__row">
          <dt class="govuk-summary-list__key">
            Check type
          </dt>
          <dd class="govuk-summary-list__value" id="check-type-display">
            <!-- Will be populated from form data -->
          </dd>
        </div>
        <div class="govuk-summary-list__row">
          <dt class="govuk-summary-list__key">
            Check will be recorded
          </dt>
          <dd class="govuk-summary-list__value" id="record-display">
            <!-- Will be populated from form data -->
          </dd>
        </div>
        <div class="govuk-summary-list__row">
          <dt class="govuk-summary-list__key">
            Data to be returned
          </dt>
          <dd class="govuk-summary-list__value" id="data-display">
            <!-- Will be populated from form data -->
          </dd>
        </div>
        <div class="govuk-summary-list__row">
          <dt class="govuk-summary-list__key">
            Created
          </dt>
          <dd class="govuk-summary-list__value" id="created-time">
            <!-- Will be populated with current time -->
          </dd>
        </div>
        <div class="govuk-summary-list__row">
          <dt class="govuk-summary-list__key">
            Expires
          </dt>
          <dd class="govuk-summary-list__value" id="expiry-time">
            <!-- Will be populated with expiry time -->
          </dd>
        </div>
      </dl>

      <h2 class="govuk-heading-m">What happens next</h2>
      
      <p class="govuk-body">
        Share this code with the organisation that needs to verify your identity. They will:
      </p>
      
      <ol class="govuk-list govuk-list--number">
        <li>Enter the code into their verification system</li>
        <li>Receive confirmation of your identity</li>
        <li>Receive the data you've chosen to share (if any)</li>
      </ol>

      <p class="govuk-body">
        You can view this check in your <a href="/history" class="govuk-link">history</a> if you chose to record it.
      </p>

      <div class="govuk-button-group govuk-!-margin-top-6">
        <a href="/create-temp-code" class="govuk-button govuk-button--secondary" data-module="govuk-button">
          Create another code
        </a>
        <a href="/digital-id-home" class="govuk-link">
          Return to home
        </a>
      </div>
    </div>
  </div>

  <!-- QR Code Library -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

  <script>
    // Generate a 32-character random code
    function generateTempCode() {
      var chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // Removed confusing characters
      var code = '';
      for (var i = 0; i < 32; i++) {
        code += chars.charAt(Math.floor(Math.random() * chars.length));
        // Add hyphens every 8 characters for readability
        if ((i + 1) % 8 === 0 && i < 31) {
          code += '-';
        }
      }
      return code;
    }

    // Copy code to clipboard
    function copyToClipboard() {
      var codeText = document.getElementById('temp-code').textContent.trim();
      
      navigator.clipboard.writeText(codeText).then(function() {
        // Show success message
        var successMsg = document.getElementById('copy-success');
        successMsg.style.display = 'inline';
        
        // Hide after 3 seconds
        setTimeout(function() {
          successMsg.style.display = 'none';
        }, 3000);
      }, function() {
        // Fallback for older browsers
        var textArea = document.createElement('textarea');
        textArea.value = codeText;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        
        var successMsg = document.getElementById('copy-success');
        successMsg.style.display = 'inline';
        setTimeout(function() {
          successMsg.style.display = 'none';
        }, 3000);
      });
    }

    // Populate page with data
    (function() {
      // Generate and display the code
      var code = generateTempCode();
      document.getElementById('temp-code').textContent = code;

      // Generate QR code
      var qrcodeContainer = document.getElementById('qrcode');
      if (qrcodeContainer && typeof QRCode !== 'undefined') {
        new QRCode(qrcodeContainer, {
          text: code,
          width: 150,
          height: 150,
          colorDark: '#0b0c0c',
          colorLight: '#ffffff',
          correctLevel: QRCode.CorrectLevel.H
        });
      }

      // Get form data from URL parameters or use defaults
      var urlParams = new URLSearchParams(window.location.search);
      
      var checkType = urlParams.get('check-type') || 'Right-to-Work';
      var recordCheck = urlParams.get('record-check') || 'yes';
      var dataReturn = urlParams.get('data-return') || 'photo-name';

      // Display check type
      document.getElementById('check-type-display').textContent = checkType;

      // Display record status
      document.getElementById('record-display').textContent = recordCheck === 'yes' ? 'Yes' : 'No';

      // Display data return option
      var dataReturnText = {
        'none': 'None (verification only)',
        'photo': 'Photo only',
        'photo-name': 'Photo and full name',
        'full': 'Photo, full name, date of birth and nationality'
      };
      document.getElementById('data-display').textContent = dataReturnText[dataReturn] || dataReturnText['photo-name'];

      // Display created time
      var now = new Date();
      var timeString = now.toLocaleString('en-GB', { 
        day: 'numeric', 
        month: 'long', 
        year: 'numeric',
        hour: '2-digit', 
        minute: '2-digit'
      });
      document.getElementById('created-time').textContent = timeString;

      // Display expiry time (1 hour from now)
      var expiry = new Date(now.getTime() + (1 * 60 * 60 * 1000));
      var expiryString = expiry.toLocaleString('en-GB', { 
        day: 'numeric', 
        month: 'long', 
        year: 'numeric',
        hour: '2-digit', 
        minute: '2-digit'
      });
      document.getElementById('expiry-time').textContent = expiryString;
    })();
  </script>
{% endblock %}

